use sp1_core::{SP1Prover, SP1Stdin};
use wasm_bindgen::prelude::*;

const ELF: &[u8] = include_bytes!("../../../../program/elf/riscv32im-succinct-zkvm-elf");

#[wasm_bindgen]
pub struct Wrapper {
    blockhash: Vec<u8>,
    challenge: Vec<u8>,
    proof: Vec<u8>,
}

#[wasm_bindgen]
impl Wrapper {
    #[wasm_bindgen(constructor)]
    pub fn new(blockhash: Vec<u8>, challenge: Vec<u8>, proof: Vec<u8>) -> Wrapper {
        Wrapper {
            blockhash,
            challenge,
            proof,
        }
    }
    pub fn blockhash(&self) -> Vec<u8> {
        self.blockhash.clone()
    }
    pub fn challenge(&self) -> Vec<u8> {
        self.challenge.clone()
    }
    pub fn proof(&self) -> Vec<u8> {
        self.proof.clone()
    }
}

#[wasm_bindgen]
pub fn prove(inputs: &[u8]) -> Wrapper {
    let mut stdin = SP1Stdin::new();
    stdin.write_slice(&inputs);

    let mut proofwio = SP1Prover::prove(ELF, stdin).expect("proving failed");
    // let mut stdout = SP1Prover::execute(ELF, stdin).expect("execution failed");

    let blockhash = proofwio.stdout.read::<[u8; 32]>();
    let challenge = proofwio.stdout.read::<[u8; 32]>();

    let wrapper = Wrapper::new(
        blockhash.to_vec(),
        challenge.to_vec(),
        bincode::serialize(&proofwio.proof).expect("serialization failed"),
    );

    return wrapper;
}

#[cfg(test)]
mod test {
    use crate::prove;
    use wasm_bindgen_test::wasm_bindgen_test;
    wasm_bindgen_test::wasm_bindgen_test_configure!(run_in_browser);

    #[wasm_bindgen_test]
    pub fn test_prove() {
        let witness = const_hex::decode("38ba7f4278a1482fa0a7bc8b261a9a673336eddca225aed0c0283cef82b24485b8b28fb756fc9ce83d25e5cf799d0c8aa20ce6b719e03a97c11cec1d5912b4ff883df90cfc4dbc8d77616c79451aae45ba0bce359276dd802bae68f79e2c91fe580a53599603818804ede9c7dab86eaae4e97eee42243b561200395eaa63a8ee023b79dabae7189866a1f5c889e2a48e7f0fe0671a1a9a6ec067234252fc23d745dd8bcf03e73e895f4374845f3dc65fab5dd47007000000000000001402000000000000f90211a0a7b0fa534114926a4295e5df177f2945ddf3e55c27df5a7061c9777913e7689ea066b3f3a2d2414bd42c3f250f8b794d3b84f370c558e0b618eabfd83a5ef1398da0c12803d8c11ad1cd78a4609f1c7d597a0cbd2e45c79df85c78d53e9ce105b3aba089afb2213314bf554d51cb3ac0c307335f7b41c1704b10d9340b44b03e722ef1a091f7fffc7359bc6f875ae1903d218acab72093eb76b3ceb6612db04fc9fefdb8a0e3e195ab7baaa7ded25e4c17391a55f246263611352054507aab187dd87d8868a000c2ac4b7a6c305c37ad71848fc151d19f0c265b490758bf0492228c2307f039a0667b5852d7ebb6aad93eae6f678491b0d29a7808d0cafae9318e66dfaa1862e3a066c74361467b4b8a4dfa188dabf274c6567dc5c03aa34bc85e0d11ef03448449a0a2110b65924494ecd76df7b74b9319b81bb31ad09a19493466ce6aed298d6e0da0bc297613616f599fc9e92087854d9a90224ee199dd031996f56b32e2f36f9ec3a0eee9d2a3fa12007bcc1a314b2494ec2b3a727f53523e657a0ebe4833e09d8a62a0c7290a739c8a02d82a35a2e70a9aec2d791621603256cc4abe85cd9b27e1a075a0590e1599a80bf5aa8fa2d62922d258aad71165b0dbc628825d4ed018ab33f2b8a04a49ba0b46c682b52b8106b07767948a6467f8b621f172bf6141a1a15e1e599aa0b6b13e5ee83a913e52d9903e00bf072060375c9b7cebaf5d5714bd3c448b7559801402000000000000f90211a018ae75317f4783820b310cedfd0af08268ca7970f376a7ab12746d0ebd756895a008aec37689fa0279e45f0e9488366456e71699ec7d7a4c9f0ce2ecb7b9da24a1a0d1e95005b363603964b51869a7ab7907bf9f873e7a5668dc23232adffa896512a02a971c79d34b7960640c0c5dc07b5a452fb0269003fc31f8d2e6b525a8f5dc06a0bc642d5326011f6ca58159e08b12f0cf33f8b1d17357da3cf9e26f052bf94c27a052ac7dc1c8f303c9ec282dd25fe1dd41aa141dde16c9209f9068e95abfbb28d2a08eace2ad1321d753e59f4d23fb01cb5ba81da5ce6468e751269f8431a129113fa033571a1568038b976ddb74eeb7d16fb8dc85ad52917c6546fc1960cc1ba1325ba07a6a5a7fcdaecfc6f8958bd3105f33effe348067033cf3a28a17765730c4ede1a06411c32b408ff603a137a13edde9d1ad1256e2348a78dccc956b0c35842a558ba0c20c1be802cdc74aa7efdcdf98982251d0b372fb783db70b7193d24ccfa51f21a06a2d72122213f418f4e74e78917aa0aea0a4fee5864cdeca60ba3c5b077b706aa0cf591505d4cfe0d83ad6b4d7927ffaec904dfbdc3288433e29cf59372b6967c6a007a2e5f63eff21ee6a59996d86c7ab81f43f20d3a52fbdf9f7bba8131cc11c68a0e59dd34eb43a0edf46715f73748496c9fbb51d72f1c5f405e686da8508932c2ba064af51b4faba197b67e42085c3ae405fd205d190e7d615f77faeb68ea0046552801402000000000000f90211a017825a5eb563c3c8290918379b4d1d6a3dff5bfed566065fc6db470aa26ed811a01442ebd2eb9ee9122393e83f3d6dffff4ea2e9642c7bc33e044f264cde01b1e1a0011ba101c02e1c956a0945992694b84335c31b0b060503dd13b8d341b396a5bfa00f691674daa7934d605e6260ac8e16b63de86ad5a87d9639bcc1dd83f7fca728a08c2668e61e653443d8bb52ac0cdad850b5512e0bb42fbd7720ccb37aceef37f8a011584b72025cec22c5584f8e511c476e7cf56a11804f2c043544b5906ef59c73a0f9e0ebbb71408118cf3968d4e28180947cd9a019b8341920313c13778b5c87b6a0e81282de3d15f07f7f3387ca511056f0d6465e56ccb530eb4b1948259a7ca4d0a0c7e97398f8dc288c5894f78a4239e8517caad528f275ad919c59ae3218ea2fe7a087ee5274957eeeb9058e0df9ebe354f627e91e1c4966cfee5b6a370f5c93121fa083c54021bf8e90d20643fb39794019b2c1bd3e83f78e9805bcedc70a56eb13f8a0af49216aac132e7a90ceec18e606e16b3987e370ec1cdb5cdf29aed09e42b745a02e0d45ad063ac6d702a7a2e8ef8fa02787aaeea787b2d3eb4c61dd3c73feefcea0d43ad9fc2b336c11fd03c3adfa8b054aefe2a566f445a07bef2b84b57b45345ba0a8cd5afc50bbdcabb92685da0d8471a2efb75baa201a8929a24b9f6a0420961ea079d82be28b05aa45e6be6bc07df802ca058042dc69cc2383a3d7702f438b78a4801402000000000000f90211a04584dc2870bfd1cd9f356874fc7eb53889749fe8aa34ce9a0e165cfdb0b72fdba000881db93a92f2442b731ae128677a20d096f3bcfd8815a95627b3ddb73addfba037410b0c75fd89c6490b2a9ed8b2d092b9e9b39f3cb43a9f2e33402543440fc2a0540033f43cae0cef3a4237a3439052b8ac7754499db2ef93ed3619a409b40ed1a02f5b10e098d91e452e5dfb0872c83ab7dd2be5eaa5cd3be14741f1323ef97fd4a0925f5e079d7e0cab32af9f1eb17e3cca921966282e06d88653da0d18163ba55ca0f479799a69c61b7fbafe06d756c2ddf118c0b6919b3564b4759af0729731fac7a011edc70505bd7adcb1c04bb4a3c4d3bbdb8f9e2741d27023bfa0fd77caf0a4caa003ae1c53be4da70aea7bdea13327138db8e6122ebd11fb1b53b9a744e3a6ff6da0e5f8fbf2cb84a212f71888ca21cd5aeb07e87b893e7096804bcedd7e9be19c91a075e5edf411760c127fdf0b5204586bb70bc63d4476286309fc0726977cec4a6ca0b69dcba31e6ac428d7387d01395f90cf3a7f6afc5e39e71b6bf039c79a978bdba0e3fb5296d38b7d6aceb7828606b85364a29ef2e8d7876873bf3e7cadb76efb56a052952ad040e074df4d06f6a58daf6e3c4696377fefda37ab7357cde79b1d46a0a01bdbadfc954044ec89bbcf734649a5e9a72c0225113d00b95489f2c53c411c83a091002f901e1951c5ff694e280e1c5288e6d434fc1ecad7b5d922cf3fd011b2d7801402000000000000f90211a0aa560e316e030f8e65512ee923899b5f6fce749e270337785c8db42ee67dc3baa051653a46592927aabf06322603da35034161e05f6ea7489fa900e0bae72b7f30a03856a23e889497a3c98915adb274ab186ad41a3e59e6a84fe38b8c5b89619fdda05f2b3953a2b4cc82686fab6e76cb9a02b0691090ca7061557425c1db82d14e8da08ed287e2da46a24b4ce11d11b18328bac6e348ea17b6016608f269439306b1fea030e76f74825ecdb1fb222b649689342d4629149323a312c964662ad61e7c7a1ea0307e539800f47b152553a71df7eb7fe96b89ad999ff79a69e70a5ce0b50a2227a0441c04ce253a6b2c5e94e8f2a349f0959605a0fd96b20623d0aa7c3f71f3a1cda0f994f3dd03240e85b4855b30119837c2fde6db24f1584a49a20a628e9ffc0ccfa002f8b1db1938a3a09683accb8d58c9439ba1aa1ec73a9cb927406e5bd9de6715a0b35518c61caba1ac9da1deb7346f195a37e48ee5927e791b2edf9cdf60dae9fda032059d94a92d483c893bbf05d2031a8ced34a0d6d65bd8aa597832acaf58e528a0f3e490e56507a176430872588e9c76325cea20ac85eb07c125e0f145896b99b4a0b117d91464a3b6f62e0e4677ed9c988d7ab0b1561cfbd24889f879c6980593eaa0283e9a7bcb081f0e079a39b124f4e8579efaf28c5efeed9f9491abcc52e6e579a0c6ad489e4893191815e0404f35c1d6f25430177eca52aa45dbea1157fe4176d2809300000000000000f891808080a08d17c3d3f8b548774c65cfd2dca0884d3c4236bff1e93f464d61972db557fb69808080a0ed67839fca56585d7378c4c91bb1e5547939668cfd9bdae11ed3456d7ff6e7bb80a0b761ca5119cc67261f6fa7b5551ddb9dc11f8e58b53082e072dcafd59e18d22c80a0b72c8825273b54046caff353926b9366b2adbf1eda8df5c7ed1b9f385c1689a180808080806900000000000000f8679e20561200395eaa63a8ee023b79dabae7189866a1f5c889e2a48e7f0fe067b846f8440180a09276dd802bae68f79e2c91fe580a53599603818804ede9c7dab86eaae4e97eeea0b89c1b3bdf2cf8827818646bce9a8f6e372885f8c55e5c07acbd307cb133b00003000000000000003401000000000000f90131a0db84880ea6ca86b1065c9a2c61033daff2455d0e3a10867ff300b4863218a18aa07d7afd2ba5ad4c7085699c7505cf9cb67ea074b7116c7b2073f56736498e52d0a0150507169b2f23aa57226a33553af0684d7ee8ebfec67cbe90693640bfe94d19808080a04616444ecc68fd60c58a3705a3dbd7a178af8dbf50e2be26bf9b2e94e89db4a3a026e732b882408cd7b9e39ed706992d0526f0d60193f666181124e807baff6d7fa06512473128eb2f4b680fdcfd7e3d05ec0ad9bdccbfe10dbea0e8519945ce8df780a02cd9a8f9c26e2a581de890b50b387477748c69d7ddcbab84ec280e201ded7b4980a0b92bbcfcacad3b833b4d2a4993069af365b8ae1fb94abe5cd3f89d97ee911462a0f0be3262950058a03bc547c666135e195c9108f123de8111226f5938fbdfae8d8080805300000000000000f85180808080808080808080a0f86e42085f656503c98a723a490d38856efaca22869239c50173ccca1f402412808080a001a5aff7191fdb70f92336addbc265906d0f57c6c718bed42199aeb2c23a4ae580802300000000000000e2a0201a9a6ec067234252fc23d745dd8bcf03e73e895f4374845f3dc65fab5dd470015202000000000000f9024fa04259e7c8c3884c26169a2fdade9ebe56fffb64bd17c5228af5aa438d7bf019cca01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d493479454e191b01aa9c1f61aa5c3bce8d00956f32d3e71a019e03a97c11cec1d5912b4ff883df90cfc4dbc8d77616c79451aae45ba0bce35a0cec8c36dfc695279c29f7d977f883cd92d54b04c7da7d8b726e5750b9ae985d9a0880e8277cd46e90c73d763fd7f2fbecd600358d0e1b45f1bfe74ab9fd620f43eb90100b20a4024e05888125086402008a80230420c4b2016128a1c8d014080842a001004025820130224120720000220d000420aa02a000202202404001300032436c3804452300828000000d25069142608222620228011a41820109c2121013000010844144002900b002821a440a54248022ac0104c0880016080401a521004500600024c0015800881a84112c08000800c00012c952d10440b0040400b00000080021010009029428a0051684f8284a514142022048d540900880522a0081000c494891927401a184200084981080012c160444111020800802401801400396041181000a42418006a801030120481008210227100081f23503101182c0a502140808401f8a9c88401036640833c739e8465feb2ca8a4e65746865726d696e64a0858e05a45cc4eb260b42a6321e0ef29ad8ec680f3808250d43d3dcc07e8eb7c588000000000000000084165f29eea0662a4abd9bb9a7275f8431289fcf3b8e7d75846eb048601b7b80dda5533fbd088080a0d518b180fb4af718fd08f31a3e191f7dfd2c58aa76a1ba8e1511026a81b334c0").expect("binary witness");

        let wrapper = prove(&witness);

        assert_eq!(wrapper.blockhash().len(), 32);
        assert_eq!(wrapper.challenge().len(), 32);
        assert!(wrapper.proof().len() > 0);
    }
}